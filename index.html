<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ò–≥—Ä–∞ –ú–µ–º–æ—Ä–∏. –ò–≥—Ä–∞ –¥–ª—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –ø–∞–º—è—Ç–∏ –Ω–∞ —Ä–∞–∑–Ω—ã—Ö –Ω–∞–±–æ—Ä–∞—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</title>
  <link rel="stylesheet" href="css/style.css">
  <script src="vendor/react.development.js"></script>
  <script src="vendor/react-dom.development.js"></script>
  <script src="vendor/babel.min.js"></script>
  <script src="js/data.js"></script>
  <script src="js/setting.js"></script>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const container = document.getElementById('root');
    const root = ReactDOM.createRoot(container);
    root.render(<App images={images} results={results}/>);

    // üéÆ –õ–æ–≥–∏–∫–∞ –∏–≥—Ä—ã –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º —Ö—É–∫–µ 
    const useGame = (images) => {
      const [finishedItems, setFinishedItems] = React.useState([]);
      const [stepsCount, setStepsCount] = React.useState(0);
      const [errors, setErrors] = React.useState(0);

      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä—ã –∫–∞—Ä—Ç–æ—á–µ–∫ 
      const checkItems = (firstItem, secondItem) => {
        const firstImage = images.find(({id}) => id === firstItem);
        const secondImage = images.find(({id}) => id === secondItem);
        
        if (firstImage.url === secondImage.url) {
          // –ü–∞—Ä–∞ —Å–æ–≤–ø–∞–ª–∞ - –¥–æ–±–∞–≤–ª—è–µ–º –≤ –æ—Ç–≥–∞–¥–∞–Ω–Ω—ã–µ
          setFinishedItems((items) => [...items, firstItem, secondItem]);
        } else {
          // –ü–∞—Ä–∞ –Ω–µ —Å–æ–≤–ø–∞–ª–∞ - —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º –æ—à–∏–±–∫–∏
          setErrors((e) => e + 1);
        }
        // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ —à–∞–≥–æ–≤
        setStepsCount((i) => i + 1);
      };

      // –°–±—Ä–æ—Å –∏–≥—Ä—ã
      const handleReset = () => {
        setFinishedItems([]);
        setStepsCount(0);
        setErrors(0);
      };

      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–±–µ–¥—ã
      const isWin = finishedItems.length > 0 && finishedItems.length === images.length;
      
      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Ä–∞–∂–µ–Ω–∏—è
      const isGameOver = errors >= GAME_SETTINGS.LIVES_COUNT;

      return {
        finishedItems,
        handleReset,
        stepsCount,
        errors,
        checkItems,
        isWin,
        isGameOver
      };
    };

    function App({images = [], results = []}) {
      // –≠–∫—Ä–∞–Ω—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
      const [currentScreen, setCurrentScreen] = React.useState(SCREENS.GAME);
      const [currentResult, setCurrentResult] = React.useState(null);
      const [allResults, setAllResults] = React.useState(results);

      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∏–≥—Ä—ã
      const handleGameFinish = React.useCallback((gameData) => {
        const newResult = {
          name: '–í–∞—à —Ä–µ–∑—É–ª—å—Ç–∞—Ç',
          stepsCount: gameData.moves,
          errors: gameData.errors,
          timestamp: new Date().toISOString(),
          isCurrent: true
        };
        setCurrentResult(newResult);
        
        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º
        const updatedResults = [...allResults, newResult];
        setAllResults(updatedResults);
        
        // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ —ç–∫—Ä–∞–Ω —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        setCurrentScreen(SCREENS.RESULTS);
      }, [allResults]);

      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–æ–≤–æ–π –∏–≥—Ä—ã
      const handleNewGame = () => {
        setCurrentScreen(SCREENS.GAME);
        setCurrentResult(null);
      };

      // –†–µ–Ω–¥–µ—Ä–∏–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π —ç–∫—Ä–∞–Ω
      if (currentScreen === SCREENS.RESULTS) {
        return (
          <ResultScreen 
            currentResult={currentResult}
            allResults={allResults}
            onNewGame={handleNewGame}
          />
        );
      }

      return (
        <GameScreen 
          images={images}
          onGameFinish={handleGameFinish}
          onShowResults={() => setCurrentScreen(SCREENS.RESULTS)}
        />
      );
    }

    // –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –∏–≥—Ä–æ–≤–æ–≥–æ —ç–∫—Ä–∞–Ω–∞
    function GameScreen({ images, onGameFinish, onShowResults }) {
      const {
        finishedItems,
        handleReset,
        stepsCount,
        errors,
        checkItems,
        isWin,
        isGameOver
      } = useGame(images);
      // –£–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–∫–∞–∑–æ–º –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ–±–µ–¥—ã
      const [showVictoryModal, setShowVictoryModal] = React.useState(false);
      React.useEffect(() => {
        if (isWin) {
          const timerId = setTimeout(() => setShowVictoryModal(true), 100);
          return () => clearTimeout(timerId);
        }
      }, [isWin]);

      // –í—ã—á–∏—Å–ª—è–µ–º –ø—Ä–æ–∏–∑–≤–æ–¥–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
      const totalPairs = images.length / 2;
      const matchedPairs = finishedItems.length / 2;
      const remainingLives = GAME_SETTINGS.LIVES_COUNT - errors;

      return (
        <section className="game container">
          <GameHeader 
            moves={stepsCount}
            progress={(matchedPairs / totalPairs) * 100}
            remainingLives={remainingLives}
            matchedPairs={matchedPairs}
            totalPairs={totalPairs}
          />
          
          <GameBoard
            images={images}
            finishedItems={finishedItems}
            checkItems={checkItems}
            isGameOver={isGameOver}
          />

          {(isGameOver || showVictoryModal) && (
            <GameModal 
              isWin={isWin}
              moves={stepsCount}
              matchedPairs={matchedPairs}
              onRestart={() => {
                setShowVictoryModal(false);
                handleReset();
              }}
              onShowResults={() => {
                onGameFinish({
                  moves: stepsCount,
                  errors: errors
                });
                onShowResults();
              }}
            />
          )}
        </section>
      );
    }

    // –ö–æ–º–ø–æ–Ω–µ–Ω—Ç —à–∞–ø–∫–∏ –∏–≥—Ä—ã
    function GameHeader({ moves, progress, remainingLives, matchedPairs, totalPairs }) {
      return (
        <>
          <div className="progress-wrapper">
            <div className="progress" style={{ width: `${progress}%` }}></div>
          </div>
          <p className="progress-description">
            –û—Ç–∫—Ä—ã—Ç–æ <span>{matchedPairs}</span> / <span>{totalPairs}</span>
          </p>
          <div className="steps">–®–∞–≥ {moves}</div>
        </>
      );
    }

    // –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –∏–≥—Ä–æ–≤–æ–≥–æ –ø–æ–ª—è 
    function GameBoard({images = [], finishedItems, checkItems, isGameOver}) {
      const [visibleItems, setVisibleItems] = React.useState([]);

      const handleCardClick = React.useCallback((id) => {
        // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –∫–ª–∏–∫–∏ –µ—Å–ª–∏ –∏–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞, –∫–∞—Ä—Ç–æ—á–∫–∞ –æ—Ç–≥–∞–¥–∞–Ω–∞ –∏–ª–∏ —É–∂–µ –≤–∏–¥–∏–º–∞
        if (isGameOver || finishedItems.includes(id) || visibleItems.includes(id)) {
          return;
        }

        // –õ–æ–≥–∏–∫–∞ –∫–ª–∏–∫–∞ –ø–æ –∫–∞—Ä—Ç–æ—á–∫–∞–º
        switch (visibleItems.length) {
          case 0:
            // –ü–µ—Ä–≤–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ - –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º
            setVisibleItems([id]);
            break;
          case 1:
            // –í—Ç–æ—Ä–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø–∞—Ä—É
            setVisibleItems((items) => [...items, id]);
            checkItems(visibleItems[0], id);
            
            // –°—Ç–∞–≤–∏–º —Ç–∞–π–º–µ—Ä –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –≤–∏–¥–∏–º—ã—Ö –∫–∞—Ä—Ç–æ—á–µ–∫
            setTimeout(() => {
              setVisibleItems([]);
            }, GAME_SETTINGS.FLIP_DELAY);
            break;
          default:
            // –¢—Ä–µ—Ç—å—è –∫–∞—Ä—Ç–æ—á–∫–∞ –∏ –±–æ–ª—å—à–µ - –ø—Ä–æ—Å—Ç–æ –æ—á–∏—â–∞–µ–º –≤–∏–¥–∏–º—ã–µ
            setVisibleItems([]);
        }
      }, [isGameOver, finishedItems, visibleItems, checkItems]);

      return (
        <ul className="cards cards-theme-cars">
          {images.map((item) => (
            <Card
              key={item.id}
              item={item}
              isVisible={visibleItems.includes(item.id)}
              isFinished={finishedItems.includes(item.id)}
              onCardClick={handleCardClick}
            />
          ))}
        </ul>
      );
    }

    // –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –∫–∞—Ä—Ç–æ—á–∫–∏
    function Card({item, isVisible, isFinished, onCardClick}) {
      const {id, url, description} = item;
      const className = `${
        isVisible ? 'card-show' : ''
      } ${
        isFinished ? 'card-finished' : ''
      }`;

      const handleClick = () => {
        onCardClick(id);
      };

      return (
        <li onClick={handleClick} className={`card ${className}`}>
          <img
            width="204" height="144"
            src={url}
            alt={description}
          />
        </li>
      );
    }

    // –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    function GameModal({ isWin, moves, matchedPairs, onRestart, onShowResults }) {
      return (
        <div className="modal">
          <div className="modal-box">
            <h3 className="modal-caption">
              {isWin ? '–ü–æ–±–µ–¥–∞!' : '–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞'}
            </h3>
            <p className="modal-description">
              {isWin 
                ? '–¢–µ–ø–µ—Ä—å –¥–∞–≤–∞–π—Ç–µ —É–∑–Ω–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —ç—Ç–æ–π –ø–∞—Ä—Ç–∏–∏'
                : `–í—ã —Å–æ–±—Ä–∞–ª–∏ ${matchedPairs} –ø–∞—Ä`
              }
            </p>
            <div className="modal-buttons">
              {isWin ? (
                <button 
                  className="button modal-button" 
                  type="button" 
                  onClick={onShowResults}
                >
                  –ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
                </button>
              ) : (
                <>
                  <button className="button modal-button" type="button" onClick={onRestart}>
                    –ù–æ–≤–∞—è –∏–≥—Ä–∞
                  </button>
                  <button 
                    className="button" 
                    type="button" 
                    onClick={onShowResults}
                  >
                    –†–µ–∑—É–ª—å—Ç–∞—Ç—ã
                  </button>
                </>
              )}
            </div>
          </div>
        </div>
      );
    }

    // –ö–æ–º–ø–æ–Ω–µ–Ω—Ç —ç–∫—Ä–∞–Ω–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    function ResultScreen({ currentResult, allResults, onNewGame }) {
      // –û–±—ä–µ–¥–∏–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏ —Å–æ—Ä—Ç–∏—Ä—É–µ–º
      const combinedResults = React.useMemo(() => {
        const results = [...allResults];
        
        if (currentResult) {
          // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ç–µ–∫—É—â–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
          const filteredResults = results.filter(result => !result.isCurrent);
          return [currentResult, ...filteredResults].sort((a, b) => a.stepsCount - b.stepsCount);
        }
        
        // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ö–æ–¥–æ–≤
        return results.sort((a, b) => a.stepsCount - b.stepsCount);
      }, [allResults, currentResult]);

      return (
        <section className="result container">
          <h2>–õ—É—á—à–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã:</h2>
          
          {currentResult && (
            <p>
              –í—ã –∑–∞–≤–µ—Ä—à–∏–ª–∏ –∏–≥—Ä—É –∑–∞ <b>{currentResult.stepsCount} —à–∞–≥–æ–≤</b>, —Ç–∞–∫ –¥–µ—Ä–∂–∞—Ç—å!
            </p>
          )}
          
          {combinedResults.length > 0 ? (
            <table className="result-table">
              <thead>
                <tr className="result-table-row">
                  <th>–ú–µ—Å—Ç–æ</th>
                  <th>–ò–º—è</th>
                  <th>–®–∞–≥–∏</th>
                </tr>
              </thead>
              <tbody>
                {combinedResults.map((result, index) => (
                  <tr 
                    key={`${result.name}-${result.stepsCount}-${index}`}
                    className={`result-table-row ${result.isCurrent ? 'active' : ''}`}
                  >
                    <td>{index + 1}</td>
                    <td>{result.name}</td>
                    <td>{result.stepsCount}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          ) : (
            <p>–ü–æ–∫–∞ –Ω–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤. –°—ã–≥—Ä–∞–π—Ç–µ –∏–≥—Ä—É, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Å–≤–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç!</p>
          )}
          
          <p>–•–æ—Ç–∏—Ç–µ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –µ—â—ë —Ä–∞–∑?</p>
          
          <div style={{ display: 'flex', justifyContent: 'center', marginTop: '24px' }}>
            <button 
              className="button result-button" 
              type="button"
              onClick={onNewGame}
            >
              –ù–æ–≤–∞—è –∏–≥—Ä–∞
            </button>
          </div>
        </section>
      );
    }

  </script>
</body>
</html>